// src/features/shinydex/shinylivingdex.js
// v2.0.0-alpha.1
// Shiny Living Dex â€” species ownership snapshot
// Render-only. No state. No side effects.

import { renderUnifiedCard } from '../../ui/unifiedcard.js';
import { prettifyPokemonName } from '../../utils/utils.js';
import {
  POKEMON_SHOW,
  POKEMON_REGION,
  POKEMON_TIER,
  POKEMON_DEX_ORDER,
  pokemonFamilies
} from '../../data/pokemondatabuilder.js';
import { buildShinyLivingDexModel } from '../../domains/shinydex/livingdex.model.js';

function getPokemonGif(key) {
  return `https://img.pokemondb.net/sprites/black-white/anim/shiny/${key}.gif`;
}

function resolveFamilyKeyByName(partialName) {
  const q = String(partialName || '').toLowerCase().trim();
  if (!q) return null;

  const keys = Object.keys(pokemonFamilies);
  for (let i = 0; i < keys.length; i++) {
    const familyKey = keys[i];
    const stages = pokemonFamilies[familyKey] || [];
    for (let j = 0; j < stages.length; j++) {
      const mon = stages[j];
      const pretty = prettifyPokemonName(mon).toLowerCase();
      if (pretty.indexOf(q) !== -1) return familyKey;
    }
  }
  return null;
}

function matchRegion(pokemonKey, regionText) {
  const rt = String(regionText || '').toLowerCase().trim();
  if (!rt) return true;
  const r = (POKEMON_REGION[pokemonKey] || 'unknown').toLowerCase();
  return r.indexOf(rt) === 0;
}

function matchTier(pokemonKey, tierText) {
  const tt = String(tierText || '').toLowerCase().trim();
  if (!tt) return true;
  const tier = (POKEMON_TIER[pokemonKey] || '').toLowerCase().replace('tier', '').trim();
  return tier === tt;
}

export function renderShinyLivingDex({
  showcaseRows,
  sort,
  unclaimedOnly,
  query,
  countLabel
}) {
  const container = document.getElementById('shiny-dex-container');
  if (!container) return;
  container.innerHTML = '';

  let dex = buildShinyLivingDexModel(showcaseRows || []).filter(
    e => POKEMON_SHOW[e.pokemon] !== false
  );

  // MODE DATASET (pre-search counters)
  dex = dex.filter(e => matchRegion(e.pokemon, query ? query.regionText : ''));
  dex = dex.filter(e => matchTier(e.pokemon, query ? query.tierText : ''));

  const requireUnclaimed = !!(query && query.requireUnclaimed);
  const requireClaimed = !!(query && query.requireClaimed);

  if (unclaimedOnly) dex = dex.filter(e => e.count === 0);
  if (requireUnclaimed) dex = dex.filter(e => e.count === 0);
  if (requireClaimed) dex = dex.filter(e => e.count > 0);

  // stable tiebreak
  const index = {};
  const order = Array.isArray(POKEMON_DEX_ORDER) ? POKEMON_DEX_ORDER : [];
  for (let i = 0; i < order.length; i++) index[order[i]] = i;

  if (sort === 'total') {
    dex.sort((a, b) => {
      const dc = (b.count || 0) - (a.count || 0);
      if (dc !== 0) return dc;
      return (index[a.pokemon] || 0) - (index[b.pokemon] || 0);
    });
  }

  // header label
  const totalSpecies = dex.length;
  const ownedSpecies = dex.filter(e => (e.count || 0) > 0).length;

  if (unclaimedOnly || requireUnclaimed) {
    countLabel.textContent = `${totalSpecies} Unowned`;
  } else {
    countLabel.textContent = `${ownedSpecies} / ${totalSpecies} Owned`;
  }

  // SEARCH (LAST)
  const pokemonNeedle = query && query.pokemonText ? query.pokemonText : '';
  const familyNeedle = query && query.familyText ? query.familyText : '';

  let familyKey = null;
  if (familyNeedle) familyKey = resolveFamilyKeyByName(familyNeedle);

  const visible = dex.filter(e => {
    if (familyKey) {
      const stages = pokemonFamilies[familyKey] || [];
      return stages.indexOf(e.pokemon) !== -1 || e.pokemon === familyKey;
    }
    if (pokemonNeedle) {
      const pretty = prettifyPokemonName(e.pokemon).toLowerCase();
      return pretty.indexOf(pokemonNeedle.toLowerCase()) !== -1;
    }
    return true;
  });

  // GROUP BY REGION
  const byRegion = {};
  visible.forEach(entry => {
    const region = (POKEMON_REGION[entry.pokemon] || 'unknown').toLowerCase();
    if (!byRegion[region]) byRegion[region] = [];
    byRegion[region].push(entry);
  });

  Object.entries(byRegion).forEach(([region, entries]) => {
    const section = document.createElement('section');
    section.className = 'region-section';

    // region header counts from MODE DATASET (not post-search)
    const regionMode = dex.filter(x => (POKEMON_REGION[x.pokemon] || 'unknown').toLowerCase() === region);
    const regionTotal = regionMode.length;
    const regionOwned = regionMode.filter(x => (x.count || 0) > 0).length;

    const header = document.createElement('h2');
    header.textContent = `${region.toUpperCase()} (${regionOwned} / ${regionTotal})`;

    const grid = document.createElement('div');
    grid.className = 'dex-grid';

    entries.forEach(entry => {
      const info =
        entry.count === 0
          ? 'Unowned'
          : entry.count === 1
            ? '1 Shiny'
            : `${entry.count} Shinies`;

      grid.insertAdjacentHTML(
        'beforeend',
        renderUnifiedCard({
          name: prettifyPokemonName(entry.pokemon),
          img: getPokemonGif(entry.pokemon),
          info,
          unclaimed: entry.count === 0,
          highlighted: entry.count > 0,
          owners: entry.owners || [],
          cardType: 'pokemon',
          pokemonKey: entry.pokemon
        })
      );
    });

    section.append(header, grid);
    container.appendChild(section);
  });
}
